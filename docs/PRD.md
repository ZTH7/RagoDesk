# PRD — RAGDesk（Go 语言多租户企业客服机器人平台）

## 1. 背景与目标
企业希望快速搭建可控、可审计的客服机器人能力，并与现有系统对接（CRM/门户）。RAGDesk 提供多租户、可配置的知识库与 RAG 能力，通过统一 API 对外提供对话服务，支持统计分析。

### 1.1 业务目标
- 为企业提供可快速落地的客服机器人平台（多租户、隔离清晰）
- 降低客服成本，提高问题自助解决率
- 通过统计分析持续优化知识库与机器人效果

### 1.2 产品目标
- 最小可用版（MVP）可在 4–6 周内落地，支持核心闭环
- RAG 能力稳定、可追踪、可回溯（引用与置信度）
- 面向开发者提供稳定 API + Key 管理 + 限流能力

### 1.3 非目标（Out of Scope）
- 不做第三方渠道（微信/钉钉/飞书等）官方连接器
- 不提供转人工服务，也不做工单系统
- 不做复杂 CRM/客服系统深度集成（仅预留 API/Webhook）

---

## 2. 目标用户与角色

### 2.1 角色定义
- **平台管理员（Platform Admin）**：管理租户、套餐、配额、系统配置
- **企业管理员（Tenant Admin）**：管理企业成员、知识库、机器人、API Key
- **客服主管（Supervisor）**：查看统计与质检，调整配置
- **开发者（Developer）**：对接企业 API，集成机器人服务

### 2.2 典型使用场景
1. 企业管理员创建租户并配置机器人
2. 上传文档 → 处理/切分 → 向量化 → RAG 训练
3. 外部系统通过 API 调用机器人
4. 统计面板查看命中率、响应时长等

---

## 3. 需求范围（核心模块）

> 以下为 **必须包含** 的核心模块与能力。

### 3.1 用户 / 企业 / 权限（多租户）
**功能清单**
- 企业入驻、创建租户（tenant）
- 企业成员管理（邀请/禁用/角色）
- RBAC 权限模型（角色-权限）
- 租户隔离（tenant_id + 数据权限）

**关键需求**
- 所有业务表必须带 `tenant_id`
- 数据查询必须做租户过滤
- 平台管理员可跨租户查看（审计级权限）

---

### 3.2 知识库 / 文档处理
**功能清单**
- 文档上传（PDF / DOC / Markdown / TXT）
- 文档清洗（去噪、去水印、格式标准化）
- 分片（chunking，支持自定义 chunk 大小/overlap）
- Embedding 向量入库（向量库 / pgvector）
- 文档版本管理、回滚

**关键需求**
- 支持异步处理队列（上传不阻塞）
- 文档处理状态追踪（待处理/处理中/成功/失败）

---

### 3.3 对话
**功能清单**
- 会话状态机：`机器人 → 关闭`
- 消息流水记录（chat_log）
- 机器人回复

**关键需求**
- 会话可追溯、可审计

---

### 3.4 检索 & RAG
**功能清单**
- 问题向量化 → 向量检索
- TopK 召回 + 可选重排
- Prompt 拼接 + LLM 调用
- 引用来源 + 置信度

**关键需求**
- RAG 输出必须带“引用来源”
- 置信度低时采用保守答复或拒答策略
- 支持可配置策略（召回阈值、TopK、重排开关）

---

### 3.5 统计与看板
**功能清单**
- 命中率、平均响应时长
- QPS、P99、P95
- 热门问题 / 知识缺失分析
- 数据导出（CSV）

**关键需求**
- 统计维度支持按企业/机器人/时间粒度
- 支持日报/周报聚合

---

### 3.6 API 管理（新增）
**功能清单**
- API Key 管理（创建/禁用/轮换）
- 访问配额与限流（QPS/每日额度）
- API 调用日志审计
- API 版本管理（v1/v2）

**关键需求**
- 每个租户独立 Key 与配额
- API 日志可导出，支持调试/追踪

---

## 4. 产品流程（核心闭环）
1. 平台创建企业租户
2. 企业管理员上传文档 → 触发异步处理
3. 处理完成后更新向量库
4. 企业系统调用 API → 生成机器人回复
5. 所有会话数据进入统计分析

---

## 5. 功能需求明细

### 5.1 API 设计（对外核心接口）
- `POST /api/v1/session` 创建会话
- `POST /api/v1/message` 发送消息（返回机器人回复 + 引用）
- `GET /api/v1/session/{id}` 查询会话状态
- `GET /api/v1/analytics` 查询统计指标

**鉴权方式**
- API Key + HMAC 签名（可选）
- 未来可扩展 OAuth2

---

### 5.2 管理端功能（后台）
- 租户管理（创建/禁用/套餐）
- 成员与角色权限
- 知识库管理（文档上传/版本/回滚）
- 机器人管理（配置、阈值、提示词）
- API Key 管理与调用统计
- 统计看板

---

## 6. 数据模型（核心表）

> 建议 MySQL + pgvector / 向量库

- **tenant**（企业）
- **user**（用户）
- **role / permission / user_role**
- **bot**（机器人）
- **knowledge_base**（知识库）
- **document / document_version**
- **chunk / embedding**
- **chat_session / chat_message**
- **api_key / api_usage_log**

---

## 7. 质量指标（KPI/验收指标）
- 机器人命中率 ≥ 60%
- 平均响应时间 ≤ 2s（P95 ≤ 4s）
- 知识库索引更新成功率 ≥ 98%

---

## 8. 非功能需求
- **性能**：单租户 QPS 100+；整体可水平扩展
- **安全**：租户隔离 + API Key 管控 + 审计日志
- **稳定性**：训练/向量化任务异步化，支持失败重试
- **可观测性**：日志、指标、Trace
- **可扩展性**：可从模块化单体演进微服务

---

## 9. 里程碑（建议）

### M1（2 周）
- 多租户 + 用户/权限 + 基础 API 骨架

### M2（3–4 周）
- 知识库 + 文档处理 + 向量化

### M3（2–3 周）
- 对话流转 + 统计分析 + API 管理

---

## 10. 风险与对策
- **RAG 命中率不足** → 增加重排/feedback 机制
- **文档质量参差不齐** → 统一清洗与预处理规则
- **多租户安全风险** → 严格 tenant_id 过滤 + RBAC

---

## 11. 未来扩展方向
- 多渠道对接（可选）
- 质检与评估模型
- 规则引擎与工作流

---

> 备注：本 PRD 强调“模块化单体 + 清晰边界”，便于后续面试解释与演进成微服务架构。
